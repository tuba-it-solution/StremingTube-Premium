<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamTube Ultra</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-base: #0f0f0f; --bg-surface: #272727; --bg-hover: #3f3f3f;
            --text-primary: #fff; --text-secondary: #aaa; --accent: #ff0000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }

        body { background: var(--bg-base); color: var(--text-primary); overflow-x: hidden; }

        /* Navbar */
        header {
            position: fixed; top: 0; width: 100%; height: 60px; background: rgba(15, 15, 15, 0.98);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000;
        }

        .logo { font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .logo i { color: var(--accent); font-size: 26px; }

        .search-bar { display: flex; width: 45%; max-width: 600px; }
        .search-bar input { flex: 1; padding: 10px 15px; background: #121212; border: 1px solid var(--bg-surface); color: #fff; border-radius: 20px 0 0 20px; outline: none; }
        .search-bar button { padding: 10px 20px; background: var(--bg-surface); border: 1px solid var(--bg-surface); border-radius: 0 20px 20px 0; color: #fff; cursor: pointer; }
        .search-bar button:hover { background: var(--bg-hover); }

        .nav-icons { display: flex; gap: 15px; align-items: center; }
        .icon-btn { background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; }

        /* Kategori */
        .categories { margin-top: 60px; padding: 12px 20px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 1px solid var(--bg-surface); }
        .categories::-webkit-scrollbar { display: none; }
        .cat-btn { padding: 6px 15px; background: var(--bg-surface); border-radius: 8px; color: #fff; cursor: pointer; white-space: nowrap; font-size: 14px; transition: 0.2s; }
        .cat-btn.active { background: #fff; color: #000; }

        /* Main Grid */
        .main-container { display: grid; grid-template-columns: 70% 30%; gap: 20px; padding: 20px; transition: 0.3s; }
        
        /* Mode Teater Class */
        .theater-mode { grid-template-columns: 100%; }
        .theater-mode .sidebar { display: none !important; }

        /* Video Player */
        .player-section { display: none; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; background: #000; border-radius: 12px; overflow: hidden; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        .video-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .video-title { font-size: 20px; font-weight: 600; }
        .action-btns { display: flex; gap: 10px; }
        .action-btn { background: var(--bg-surface); color: #fff; border: none; padding: 8px 15px; border-radius: 18px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .action-btn:hover { background: var(--bg-hover); }

        .channel-info { margin-top: 15px; display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-secondary); }
        .video-description { margin-top: 15px; background: var(--bg-surface); padding: 15px; border-radius: 12px; font-size: 14px; white-space: pre-wrap; max-height: 80px; overflow: hidden; cursor: pointer; }
        .video-description.open { max-height: none; }

        /* Sidebar Tabs */
        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        .sidebar-tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--bg-surface); padding-bottom: 5px; }
        .tab-btn { background: none; border: none; color: var(--text-secondary); font-size: 14px; font-weight: bold; cursor: pointer; padding: 5px; }
        .tab-btn.active { color: #fff; border-bottom: 2px solid #fff; }

        /* Video List (Sidebar & Grid) */
        .video-list { display: flex; flex-direction: column; gap: 10px; }
        .video-item { display: flex; gap: 10px; cursor: pointer; padding: 5px; border-radius: 8px; transition: 0.2s; }
        .video-item:hover { background: var(--bg-surface); }
        .video-item img { width: 160px; height: 90px; border-radius: 8px; object-fit: cover; }
        .video-info { flex: 1; }
        .video-item-title { font-size: 14px; font-weight: 500; margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .video-item-channel { font-size: 12px; color: var(--text-secondary); }

        /* Home Grid */
        .home-grid { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .grid-card { cursor: pointer; }
        .grid-card img { width: 100%; aspect-ratio: 16/9; border-radius: 12px; object-fit: cover; }
        .grid-info { padding: 10px 0; }
        .grid-title { font-size: 16px; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="goHome()"><i class="fab fa-youtube"></i> StreamTube</div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Cari...">
            <button onclick="handleSearch()"><i class="fas fa-search"></i></button>
        </div>
        <div class="nav-icons">
            <button class="icon-btn" onclick="showTab('watchLater')"><i class="fas fa-clock"></i></button>
            <button class="icon-btn" onclick="showTab('history')"><i class="fas fa-history"></i></button>
        </div>
    </header>

    <div class="categories">
        <div class="cat-btn active" onclick="filterCategory('video terbaru', this)">Semua</div>
        <div class="cat-btn" onclick="filterCategory('Musik Terbaru', this)">Musik</div>
        <div class="cat-btn" onclick="filterCategory('Tutorial Coding', this)">Coding</div>
        <div class="cat-btn" onclick="filterCategory('Gaming', this)">Gaming</div>
        <div class="cat-btn" onclick="filterCategory('Podcast', this)">Podcast</div>
    </div>

    <div class="main-container" id="mainLayout">
        <div class="player-section" id="playerSection">
            <div class="video-wrapper">
                <iframe id="videoPlayer" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
            
            <div class="video-actions">
                <div class="video-title" id="videoTitle">Judul</div>
                <div class="action-btns">
                    <button class="action-btn" onclick="toggleTheaterMode()"><i class="fas fa-tv"></i> Mode Teater</button>
                    <button class="action-btn" onclick="addToWatchLater()"><i class="fas fa-clock"></i> Tonton Nanti</button>
                </div>
            </div>

            <div class="channel-info"><i class="fas fa-user-circle fa-2x"></i> <span id="channelName">Channel</span></div>
            <div class="video-description" id="videoDesc" onclick="this.classList.toggle('open')"></div>
        </div>

        <div class="sidebar" id="sidebarSection" style="display: none;">
            <div class="sidebar-tabs">
                <button class="tab-btn active" id="tab-related" onclick="showTab('related')">Terkait</button>
                <button class="tab-btn" id="tab-watchLater" onclick="showTab('watchLater')">Tonton Nanti</button>
                <button class="tab-btn" id="tab-history" onclick="showTab('history')">Riwayat</button>
            </div>
            <div class="video-list" id="sidebarList"></div>
        </div>

        <div class="home-grid" id="homeGrid"></div>
    </div>

    <script>
        const API_KEY = 'AIzaSyBwRfuNzEu6WhfWeWvE4V2hQEBGw_zVpYM';
        let currentVideo = null; // Menyimpan data video yg sedang diputar

        window.onload = () => fetchVideos('video trending indonesia');
        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') handleSearch(); });

        function goHome() {
            document.getElementById('playerSection').style.display = 'none';
            document.getElementById('sidebarSection').style.display = 'none';
            document.getElementById('mainLayout').classList.remove('theater-mode');
            fetchVideos('video trending indonesia');
        }

        function filterCategory(q, el) {
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active');
            goHome(); fetchVideos(q);
        }

        function handleSearch() {
            const q = document.getElementById('searchInput').value;
            if(q) { goHome(); fetchVideos(q); }
        }

        async function fetchVideos(query) {
            const grid = document.getElementById('homeGrid');
            grid.innerHTML = '<div style="color:white;text-align:center;grid-column:1/-1;">Loading...</div>';
            
            try {
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=16&q=${encodeURIComponent(query)}&type=video&key=${API_KEY}`;
                const res = await fetch(url);
                const data = await res.json();
                
                grid.innerHTML = '';
                data.items.forEach(item => {
                    grid.innerHTML += `
                        <div class="grid-card" onclick='playVideo("${item.id.videoId}", ${JSON.stringify(item.snippet).replace(/'/g, "&apos;")})'>
                            <img src="${item.snippet.thumbnails.high.url}">
                            <div class="grid-info">
                                <div class="grid-title">${item.snippet.title}</div>
                                <div style="color: #aaa; font-size: 13px; margin-top: 5px;">${item.snippet.channelTitle}</div>
                            </div>
                        </div>`;
                });
            } catch(e) { console.error(e); }
        }

        function playVideo(videoId, snippet) {
            currentVideo = { id: videoId, snippet: snippet };
            window.scrollTo(0, 0);

            document.getElementById('homeGrid').innerHTML = '';
            document.getElementById('playerSection').style.display = 'block';
            document.getElementById('sidebarSection').style.display = 'flex';

            // SOLUSI ERROR 153: Menambahkan parameter origin ke iframe
            const iframe = document.getElementById('videoPlayer');
            const originUrl = window.location.origin;
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&enablejsapi=1&origin=${originUrl}&widget_referrer=${originUrl}`;

            document.getElementById('videoTitle').innerText = snippet.title;
            document.getElementById('channelName').innerText = snippet.channelTitle;
            document.getElementById('videoDesc').innerText = snippet.description;

            saveToStorage('yt_history_ultra', videoId, snippet);
            showTab('related');
        }

        // --- SISTEM PENYIMPANAN & TAB (RIWAYAT, TONTON NANTI, TERKAIT) ---
        function toggleTheaterMode() {
            document.getElementById('mainLayout').classList.toggle('theater-mode');
        }

        function addToWatchLater() {
            if(!currentVideo) return;
            saveToStorage('yt_watch_later', currentVideo.id, currentVideo.snippet);
            alert('Video ditambahkan ke Tonton Nanti!');
        }

        function saveToStorage(key, videoId, snippet) {
            let data = JSON.parse(localStorage.getItem(key)) || [];
            data = data.filter(v => v.id !== videoId);
            data.unshift({ id: videoId, snippet: snippet });
            if (data.length > 50) data.pop();
            localStorage.setItem(key, JSON.stringify(data));
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`)?.classList.add('active');
            
            const list = document.getElementById('sidebarList');
            list.innerHTML = '';

            // Tampilkan Sidebar jika diakses dari Header
            document.getElementById('homeGrid').innerHTML = '';
            document.getElementById('sidebarSection').style.display = 'flex';

            if(tab === 'related' && currentVideo) {
                fetchRelated(currentVideo.snippet.title);
            } else if(tab === 'watchLater') {
                renderStorageList('yt_watch_later', 'Belum ada video di Tonton Nanti.');
            } else if(tab === 'history') {
                renderStorageList('yt_history_ultra', 'Belum ada riwayat tontonan.');
            }
        }

        function renderStorageList(key, emptyMsg) {
            const list = document.getElementById('sidebarList');
            const data = JSON.parse(localStorage.getItem(key)) || [];
            
            if(data.length === 0) return list.innerHTML = `<p style="color:#aaa; text-align:center;">${emptyMsg}</p>`;

            data.forEach(item => {
                list.innerHTML += `
                    <div class="video-item" onclick='playVideo("${item.id}", ${JSON.stringify(item.snippet).replace(/'/g, "&apos;")})'>
                        <img src="${item.snippet.thumbnails.medium.url}">
                        <div class="video-info">
                            <div class="video-item-title">${item.snippet.title}</div>
                            <div class="video-item-channel">${item.snippet.channelTitle}</div>
                        </div>
                    </div>`;
            });
        }

        async function fetchRelated(title) {
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=8&q=${encodeURIComponent(title)}&type=video&key=${API_KEY}`;
            const res = await fetch(url);
            const data = await res.json();
            
            const list = document.getElementById('sidebarList');
            list.innerHTML = '';
            data.items.forEach(item => {
                list.innerHTML += `
                    <div class="video-item" onclick='playVideo("${item.id.videoId}", ${JSON.stringify(item.snippet).replace(/'/g, "&apos;")})'>
                        <img src="${item.snippet.thumbnails.medium.url}">
                        <div class="video-info">
                            <div class="video-item-title">${item.snippet.title}</div>
                            <div class="video-item-channel">${item.snippet.channelTitle}</div>
                        </div>
                    </div>`;
            });
        }
    </script>
</body>
</html>